(function(i,n){typeof exports=="object"&&typeof module<"u"?n(exports):typeof define=="function"&&define.amd?define(["exports"],n):(i=typeof globalThis<"u"?globalThis:i||self,n(i.caduceus={}))})(this,(function(i){"use strict";var T=Object.defineProperty;var y=(i,n,u)=>n in i?T(i,n,{enumerable:!0,configurable:!0,writable:!0,value:u}):i[n]=u;var r=(i,n,u)=>y(i,typeof n!="symbol"?n+"":n,u);function n(o,e){return o<e?-1:o>e?1:0}class u{create(e){return new EventSource(e.toString())}}class p{create(e){return new EventSource(e.toString(),{withCredentials:!0})}}class S{constructor(e){this.token=e}create(e,t={}){const s=new URL(e.toString());return s.searchParams.set("authorization",t.token??this.token),new EventSource(s.toString())}}const d=o=>(o.includes("*")&&(o=["*"]),[...new Set(o)]),f={eventSourceFactory:new u,lastEventId:null},l={append:!0};class b{constructor(e,t={}){r(this,"subscribedTopics",[]);r(this,"currentlySubscribedTopics",[]);r(this,"eventSource",null);r(this,"lastEventId",null);r(this,"options");r(this,"listeners",new Map);this.hub=e,this.options={...f,...t},this.lastEventId=this.options.lastEventId}subscribe(e,t={}){const{append:s}={...l,...t},c=Array.isArray(e)?e:[e];this.subscribedTopics=d(s?[...this.currentlySubscribedTopics,...this.subscribedTopics,...c]:c)}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),this.attachListener(e,t)}unsubscribe(e){const t=Array.isArray(e)?e:[e],s=this.subscribedTopics.filter(c=>!t.includes(c));this.subscribedTopics=d(s),this.connect()}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null)}connect(e={}){if(this.eventSource&&this.subscribedTopics.length>0&&n(this.subscribedTopics,this.currentlySubscribedTopics)===0)return this.eventSource;if(this.eventSource&&this.eventSource.close(),this.subscribedTopics.length===0)throw new Error("No topics to subscribe to.");const t={topic:this.subscribedTopics.join(",")};this.lastEventId!==null&&(t.lastEventID=this.lastEventId);const s=this.hub+"?"+new URLSearchParams(t);this.eventSource=this.options.eventSourceFactory.create(s,e);for(const[c,a]of this.listeners.entries())for(const h of a)this.attachListener(c,h);return this.currentlySubscribedTopics=this.subscribedTopics,this.eventSource}reconnect(e={}){this.disconnect(),this.connect(e)}attachListener(e,t){this.eventSource&&this.eventSource.addEventListener(e,s=>{this.lastEventId=s.lastEventId;const c={...s,type:e,json:()=>new Promise(a=>a(JSON.parse(s.data)))};t(c)})}}class v{constructor(e,t={}){r(this,"DEFAULT_OPTIONS",{handler:e=>{e.on("message",async t=>{const s=await t.json();if(typeof s!="object")return;const a=(this.isDeletion(s)?this.deleteListeners:this.updateListeners).get(s["@id"]);for(const h of a??[])h(s,t)})},resourceListener:e=>t=>Object.assign(e,t),subscribeOptions:{append:!0}});r(this,"connection");r(this,"updateListeners",new Map);r(this,"deleteListeners",new Map);r(this,"options");this.options={...this.DEFAULT_OPTIONS,...t},this.connection=new b(e,{...this.options});const{handler:s}=this.options;s(this.connection,this.updateListeners)}sync(e,t,s){const c=t??e["@id"];this.updateListeners.has(e["@id"])||(this.updateListeners.set(e["@id"],[this.options.resourceListener(e,this.isDeletion(e))]),this.connection.subscribe(c,{...this.options.subscribeOptions,...s}),this.connection.connect())}unsync(e){this.updateListeners.delete(e["@id"])}onUpdate(e,t){const s=this.updateListeners.get(e["@id"])??[];s.push(t),this.updateListeners.set(e["@id"],[...new Set(s)])}onDelete(e,t){const s=this.deleteListeners.get(e["@id"])??[];s.push(t),this.deleteListeners.set(e["@id"],[...new Set(s)])}isDeletion(e){return Object.keys(e).filter(s=>!s.startsWith("@")).length===0}}i.CookieBasedAuthorization=p,i.DEFAULT_SUBSCRIBE_OPTIONS=l,i.DefaultEventSourceFactory=u,i.HydraSynchronizer=v,i.Mercure=b,i.QueryParamAuthorization=S,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})}));
