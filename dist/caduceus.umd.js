(function(t,n){typeof exports=="object"&&typeof module<"u"?n(exports):typeof define=="function"&&define.amd?define(["exports"],n):(t=typeof globalThis<"u"?globalThis:t||self,n(t.caduceus={}))})(this,function(t){"use strict";var v=Object.defineProperty;var y=(t,n,u)=>n in t?v(t,n,{enumerable:!0,configurable:!0,writable:!0,value:u}):t[n]=u;var o=(t,n,u)=>y(t,typeof n!="symbol"?n+"":n,u);function n(r,e){return r<e?-1:r>e?1:0}class u{create(e){return new EventSource(e.toString(),{withCredentials:!0})}}const a=r=>(r.includes("*")&&(r=["*"]),[...new Set(r)]),S={handler:()=>{},eventSourceFactory:new u};class d{constructor(e,i={}){o(this,"subscribedTopics",[]);o(this,"eventSource",null);o(this,"lastEventId",null);o(this,"options");this.hub=e,this.options={...S,...i}}subscribe(e,i=!0){const s=Array.isArray(e)?e:[e];this.eventSource=this.connect(s,!i);const{handler:l}=this.options;this.eventSource.onmessage=c=>{this.lastEventId=c.lastEventId;const h=JSON.parse(c.data);l(h,c)}}unsubscribe(e){const i=Array.isArray(e)?e:[e],s=this.subscribedTopics.filter(l=>!i.includes(l));this.connect(s,!0)}connect(e,i){const s=i?[]:a(this.subscribedTopics),l=a(e),c=a([...s,...l]);if(this.eventSource&&c.length>0&&n(s,c)===0)return this.eventSource;if(this.eventSource&&(this.eventSource.close(),c.length===0))return this.eventSource;const h={topic:c.join(",")};this.lastEventId!==null&&(h.lastEventID=this.lastEventId);const p=this.hub+"?"+new URLSearchParams(h);return this.eventSource=this.options.eventSourceFactory.create(p),this.subscribedTopics=c,this.eventSource}}const b={resourceListener:r=>e=>Object.assign(r,e)};class f{constructor(e,i={}){o(this,"mercure");o(this,"listeners",new Map);o(this,"options");this.options={...b,...i},this.mercure=new d(e,{...this.options,handler:(s,l)=>{const c=this.listeners.get(s["@id"]);for(const h of c??[])h(s,l)}})}sync(e,i){const s=i??e["@id"];this.listeners.has(e["@id"])||(this.listeners.set(e["@id"],[this.options.resourceListener(e)]),this.mercure.subscribe(s))}on(e,i){const s=this.listeners.get(e["@id"])??[];s.push(i),this.listeners.set(e["@id"],[...new Set(s)])}unsync(e){this.listeners.delete(e["@id"])}}t.DefaultEventSourceFactory=u,t.HydraSynchronizer=f,t.Mercure=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
