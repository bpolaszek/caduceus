(function(t,s){typeof exports=="object"&&typeof module<"u"?s(exports):typeof define=="function"&&define.amd?define(["exports"],s):(t=typeof globalThis<"u"?globalThis:t||self,s(t.caduceus={}))})(this,function(t){"use strict";var v=Object.defineProperty;var y=(t,s,u)=>s in t?v(t,s,{enumerable:!0,configurable:!0,writable:!0,value:u}):t[s]=u;var o=(t,s,u)=>y(t,typeof s!="symbol"?s+"":s,u);function s(i,e){return i<e?-1:i>e?1:0}class u{create(e){return new EventSource(e.toString(),{withCredentials:!0})}}const a=i=>(i.includes("*")&&(i=["*"]),[...new Set(i)]),S={handler:()=>{},eventSourceFactory:new u};class d{constructor(e,r={}){o(this,"subscribedTopics",[]);o(this,"eventSource",null);o(this,"lastEventId",null);o(this,"options");this.hub=e,this.options={...S,...r}}subscribe(e,r=!0){const c=Array.isArray(e)?e:[e];this.eventSource=this.connect(c,!r);const{handler:h}=this.options;this.eventSource.onmessage=n=>{this.lastEventId=n.lastEventId;const l=JSON.parse(n.data);h(l,n)}}unsubscribe(e){const r=Array.isArray(e)?e:[e],c=this.subscribedTopics.filter(h=>!r.includes(h));this.connect(c,!0)}connect(e,r){const c=r?[]:a(this.subscribedTopics),h=a(e),n=a([...c,...h]);if(this.eventSource&&n.length>0&&s(c,n)===0)return this.eventSource;if(this.eventSource&&(this.eventSource.close(),n.length===0))return this.eventSource;const l={topics:n.join(",")};this.lastEventId!==null&&(l.lastEventID=this.lastEventId);const b=this.hub+"?"+new URLSearchParams(l);return this.eventSource=this.options.eventSourceFactory.create(b),this.subscribedTopics=n,this.eventSource}}const f={resourceListener:i=>e=>Object.assign(i,e)};class p{constructor(e,r={}){o(this,"mercure");o(this,"listeners",new Map);o(this,"options");this.options={...f,...r},this.mercure=new d(e,{...this.options,handler:(c,h)=>{const n=this.listeners.get(c["@id"]);n&&n(c,h)}})}sync(e,r){const c=r??e["@id"];this.listeners.has(e["@id"])||(this.listeners.set(e["@id"],this.options.resourceListener(e)),this.mercure.subscribe(c))}unsync(e){this.listeners.delete(e["@id"])}}t.DefaultEventSourceFactory=u,t.HydraSynchronizer=p,t.Mercure=d,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
