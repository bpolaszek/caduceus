(function(i,n){typeof exports=="object"&&typeof module<"u"?n(exports):typeof define=="function"&&define.amd?define(["exports"],n):(i=typeof globalThis<"u"?globalThis:i||self,n(i.caduceus={}))})(this,(function(i){"use strict";var v=Object.defineProperty;var y=(i,n,u)=>n in i?v(i,n,{enumerable:!0,configurable:!0,writable:!0,value:u}):i[n]=u;var r=(i,n,u)=>y(i,typeof n!="symbol"?n+"":n,u);function n(o,e){return o<e?-1:o>e?1:0}class u{create(e){return new EventSource(e.toString())}}class b{create(e){return new EventSource(e.toString(),{withCredentials:!0})}}class p{constructor(e){this.token=e}create(e){const t=new URL(e.toString());return t.searchParams.set("authorization",this.token),new EventSource(t.toString())}}const h=o=>(o.includes("*")&&(o=["*"]),[...new Set(o)]),S={eventSourceFactory:new u,lastEventId:null},d={append:!0};class l{constructor(e,t={}){r(this,"subscribedTopics",[]);r(this,"currentlySubscribedTopics",[]);r(this,"eventSource",null);r(this,"lastEventId",null);r(this,"options");r(this,"listeners",new Map);this.hub=e,this.options={...S,...t},this.lastEventId=this.options.lastEventId}subscribe(e,t={}){const{append:s}={...d,...t},c=Array.isArray(e)?e:[e];this.subscribedTopics=h(s?[...this.currentlySubscribedTopics,...this.subscribedTopics,...c]:c)}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),this.attachListener(e,t)}unsubscribe(e){const t=Array.isArray(e)?e:[e],s=this.subscribedTopics.filter(c=>!t.includes(c));this.subscribedTopics=h(s),this.connect()}connect(){if(this.eventSource&&this.subscribedTopics.length>0&&n(this.subscribedTopics,this.currentlySubscribedTopics)===0)return this.eventSource;if(this.eventSource&&this.eventSource.close(),this.subscribedTopics.length===0)throw new Error("No topics to subscribe to.");const e={topic:this.subscribedTopics.join(",")};this.lastEventId!==null&&(e.lastEventID=this.lastEventId);const t=this.hub+"?"+new URLSearchParams(e);this.eventSource=this.options.eventSourceFactory.create(t);for(const[s,c]of this.listeners.entries())for(const a of c)this.attachListener(s,a);return this.currentlySubscribedTopics=this.subscribedTopics,this.eventSource}attachListener(e,t){this.eventSource&&this.eventSource.addEventListener(e,s=>{this.lastEventId=s.lastEventId;const c={...s,type:e,json:()=>new Promise(a=>a(JSON.parse(s.data)))};t(c)})}}class f{constructor(e,t={}){r(this,"DEFAULT_OPTIONS",{handler:e=>{e.on("message",async t=>{const s=await t.json();if(typeof s!="object")return;const a=(this.isDeletion(s)?this.deleteListeners:this.updateListeners).get(s["@id"]);for(const T of a??[])T(s,t)})},resourceListener:e=>t=>Object.assign(e,t),subscribeOptions:{append:!0}});r(this,"connection");r(this,"updateListeners",new Map);r(this,"deleteListeners",new Map);r(this,"options");this.options={...this.DEFAULT_OPTIONS,...t},this.connection=new l(e,{...this.options});const{handler:s}=this.options;s(this.connection,this.updateListeners)}sync(e,t,s){const c=t??e["@id"];this.updateListeners.has(e["@id"])||(this.updateListeners.set(e["@id"],[this.options.resourceListener(e,this.isDeletion(e))]),this.connection.subscribe(c,{...this.options.subscribeOptions,...s}),this.connection.connect())}unsync(e){this.updateListeners.delete(e["@id"])}onUpdate(e,t){const s=this.updateListeners.get(e["@id"])??[];s.push(t),this.updateListeners.set(e["@id"],[...new Set(s)])}onDelete(e,t){const s=this.deleteListeners.get(e["@id"])??[];s.push(t),this.deleteListeners.set(e["@id"],[...new Set(s)])}isDeletion(e){return Object.keys(e).filter(s=>!s.startsWith("@")).length===0}}i.CookieBasedAuthorization=b,i.DEFAULT_SUBSCRIBE_OPTIONS=d,i.DefaultEventSourceFactory=u,i.HydraSynchronizer=f,i.Mercure=l,i.QueryParamAuthorization=p,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})}));
